(function(window){window.webspeechkit={recorderInited:false,FORMAT:{PCM8:{format:'pcm',samplerate:8000,mime:"audio/x-pcm;bit=16;rate=8000"},PCM16:{format:'pcm',samplerate:16000,mime:"audio/x-pcm;bit=16;rate=16000"},PCM44:{format:'pcm',samplerate:44100,mime:"audio/x-pcm;bit=16;rate=44100"},SPEEX8:{format:'speex',samplerate:8000,mime:"audio/x-speex"},SPEEX16:{format:'speex',samplerate:16000,mime:"audio/x-speex"}}};var scriptPath=function(){var scripts=document.getElementsByTagName('script');var path='';if(scripts&&scripts.length>0){for(var i in scripts){if(scripts[i].src&&scripts[i].src.match(/\/webspeechkit.min.js$/)){path=scripts[i].src.replace(/(.*)\/webspeechkit.min.js$/,'$1');break;}}}
return path;};var WORKER_PATH=scriptPath()+'/webspeechkitWorker.min.js';function Recorder(stream)
{function RecorderImpl(bufferSize,channelCount,onError,workerPath,outSampleRate)
{this.bufferLen=bufferSize||4096;this.channelCount=Math.max(1,Math.min(channelCount||2,2)); this.context=webspeechkit.audiocontext||new AudioContext();webspeechkit.audiocontext=this.context;this.outSampleRate=outSampleRate||this.context.sampleRate
this.inputPoint=this.context.createBiquadFilter();this.inputPoint.type="lowpass";this.inputPoint.frequency.value=this.outSampleRate;this.inputPoint.Q.value=1;this.inputPoint.gain.value=5;this.audioInput=this.context.createMediaStreamSource(stream);this.audioInput.connect(this.inputPoint);if(!this.context.createScriptProcessor){this.node=this.context.createJavaScriptNode(this.bufferLen,2,this.channelCount);}else{this.node=this.context.createScriptProcessor(this.bufferLen,2,this.channelCount);}
this.inputPoint.connect(this.node);this.node.connect(this.context.destination);this.worker=new Worker(workerPath||WORKER_PATH);this.recording=false;this.paused=false;this.lastDataOnPause=0;this.nullsArray=[];this.currCallback;this.buffCallback;this.startCallback;this.node.onaudioprocess=function(e){if(!this.recording)return;if(this.paused){if(Number(new Date())-this.lastDataOnPause>2000){this.lastDataOnPause=Number(new Date());this.worker.postMessage({command:'record',buffer:[this.nullsArray,this.nullsArray]});}}
else{this.worker.postMessage({command:'record',buffer:[e.inputBuffer.getChannelData(0),e.inputBuffer.getChannelData(1)]});}}.bind(this);this.worker.onmessage=function(e){if(e.data.command=='int16stream')
{var data=e.data.buffer;if(this.startCallback){this.startCallback(data);}}
else if(e.data.command=='getBuffers'&&this.buffCallback)
{this.buffCallback(e.data.blob)}
else if(e.data.command=='clear'&&this.currCallback)
{this.currCallback();}
else if(this.currCallback)
{this.currCallback(e.data.blob);}}.bind(this);};RecorderImpl.prototype={pause:function(){this.paused=true;this.lastDataOnPause=Number(new Date());},getAudioContext:function(){return this.context;},getAnalyserNode:function(){var analyserNode=this.context.createAnalyser();analyserNode.fftSize=2048;this.inputPoint.connect(analyserNode);return analyserNode;},isPaused:function(){return this.paused;},start:function(cb,format){if(this.isPaused()){this.paused=false;return;}
this.outSampleRate=format.samplerate;this.inputPoint.frequency.value=this.outSampleRate;this.startCallback=cb;this.worker.postMessage({command:'init',config:{sampleRate:this.context.sampleRate,format:format||webspeechkit.FORMAT.PCM44,bufSize:this.bufferLen}});this.nullsArray=[];for(var i=0;i<this.bufferLen;i++)
this.nullsArray.push(0);this.clear(function(){this.recording=true;}.bind(this));},stop:function(cb){this.recording=false;this.exportWAV(function(blob)
{cb(blob);});},isRecording:function(){return this.recording;},clear:function(cb){this.currCallback=cb;this.worker.postMessage({command:'clear'});},getBuffers:function(cb){this.buffCallback=cb;this.worker.postMessage({command:'getBuffers'})},exportWAV:function(cb,type){this.currCallback=cb;type=type||'audio/wav';if(!this.currCallback)throw new Error('Callback not set');this.worker.postMessage({command:"export"+(this.channelCount!=2&&"Mono"||"")+"WAV",type:type});}};return RecorderImpl;}
window.webspeechkit.initRecorder=function(initSuccess,initFail)
{window.AudioContext=window.AudioContext||window.webkitAudioContext;navigator.getUserMedia=(navigator.getUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.webkitGetUserMedia);window.webspeechkit.Recorder=null;var badInitialization=function(err){window.webspeechkit.recorderInited=false;window.webspeechkit.Recorder=function()
{return null;}
initFail("Could not init AudioContext: "+err);}
if(navigator.getUserMedia)
{navigator.getUserMedia({audio:true},function(stream){window.webspeechkit.Recorder=Recorder(stream);window.webspeechkit.recorderInited=true;initSuccess();},function(err){badInitialization(err);});}
else
{badInitialization("Your browser doesn't support WebRTC. Please, use Firefox or Yandex.Browser");}};}(window));(function(webspeechkit){webspeechkit.Recognizer=function(url,listener,options){this.url=url;this.listener=listener||{onInit:function(){},onResult:function(){},onError:function(){}};this.options=options;this.sessionId=null;this.socket=null;this.buffered=[];this.totaldata=0;}
webspeechkit.Recognizer.prototype={sendRaw:function(data){if(this.socket)
this.socket.send(data);},sendJson:function(json){this.sendRaw(JSON.stringify({type:'message',data:json}));},start:function(){this.socket=new WebSocket(this.url);this.socket.onopen=function(){this.sendJson(this.options);}.bind(this);this.socket.onmessage=function(e){var message=JSON.parse(e.data)
if(message.type=='InitResponse'){this.sessionId=message.data.sessionId;this.listener.onInit(message.data.sessionId,message.data.code)}
else if(message.type=="AddDataResponse"){this.listener.onResult(message.data.text,message.data.uttr,message.data.merge);}
else if(message.type=="Error"){this.listener.onError("Session "+this.sessionId+": "+message.data);this.close();}
else{this.listener.onError("Session "+this.sessionId+": "+message);this.close();}}.bind(this);this.socket.onerror=function(error){this.listener.onError("Socket error: "+error.message);}.bind(this);this.socket.onclose=function(event){}.bind(this);},addData:function(data){this.totaldata+=data.byteLength;if(!this.sessionId){this.buffered.push(data);return;}
for(var i=0;i<this.buffered.length;i++){this.sendRaw(new Blob([this.buffered[i]],{type:this.options.format}))
this.totaldata+=this.buffered[i].byteLength;}
this.buffered=[];this.sendRaw(new Blob([data],{type:this.options.format}))},close:function(){this.listener={onInit:function(){},onResult:function(){},onError:function(){}};if(this.socket)
this.socket.close();this.socket=null;}};}(window.webspeechkit));(function(webspeechkit){webspeechkit.play=function(url,cb){var audio=new Audio(url);audio.onended=cb
audio.play();};webspeechkit.Tts=function(params){this.key=params.key||'';this.ttsurl=params.url||'https://tts.voicetech.yandex.net';this.emo=params.emotion||'neutral';this.speaker=params.speaker||'jane';this.speed=params.speed||1.0;this.pitch=params.pitch||0;}
webspeechkit.Tts.prototype={say:function(text,cb,args){var emo=(args&&args.emotion)||this.emo;var key=(args&&args.key)||this.key;var ttsurl=(args&&args.url)||this.ttsurl;var speaker=(args&&args.speaker)||this.speaker;var speed=(args&&args.speed)||this.speed;var pitch=(args&&args.pitch)||this.pitch;webspeechkit.play(ttsurl+'/crafted?key='+key
+'&speaker='+speaker
+'&emotion='+emo
+'&pitch_shift='+pitch
+'&speed='+speed
+'&text='+text,cb);}};}(window.webspeechkit));(function(webspeechkit){var Vad=function(options){this.init(options);};webspeechkit.Vad=function(options){return new Vad(options);};Vad.prototype={init:function(options){ this.options={energy_offset:1e-8,energy_threshold_ratio_pos:2, energy_threshold_ratio_neg:0.5,
 energy_integration:1,speechStart:function(){},speechEnd:function(){},filter:[{f:200,v:0},{f:2000,v:1}
],recorder:null};for(var option in options){if(options.hasOwnProperty(option)){this.options[option]=options[option];}} 
this.context=this.options.recorder.context;this.analyserNode=this.options.recorder.getAnalyserNode(); this.hertzPerBin=this.context.sampleRate/this.analyserNode.fftSize;this.iterationFrequency=this.hertzPerBin;this.iterationPeriod=1/this.iterationFrequency;this.setFilter(this.options.filter);this.ready={};this.vadState=false;
 this.energy_offset=this.options.energy_offset;this.energy_threshold_pos=this.energy_offset*this.options.energy_threshold_ratio_pos;this.energy_threshold_neg=this.energy_offset*this.options.energy_threshold_ratio_neg;this.voiceTrend=0;this.voiceTrendMax=10;this.voiceTrendMin=-10;this.voiceTrendStart=5;this.voiceTrendEnd=-5; this.floatFrequencyDataLinear=new Float32Array(this.analyserNode.frequencyBinCount);},update:function(){ var fft=new Float32Array(this.analyserNode.frequencyBinCount);this.analyserNode.getFloatFrequencyData(fft);for(var i=0,iLen=fft.length;i<iLen;i++){this.floatFrequencyDataLinear[i]=Math.pow(10,fft[i]/10);}
this.ready={};this.monitor();},setFilter:function(shape){this.filter=[];for(var i=0,iLen=this.analyserNode.fftSize/2;i<iLen;i++){this.filter[i]=0;for(var j=0,jLen=shape.length;j<jLen;j++){if(i*this.hertzPerBin<shape[j].f){this.filter[i]=shape[j].v;break;}}}},getEnergy:function(){if(this.ready.energy){return this.energy;}
var energy=0;var fft=this.floatFrequencyDataLinear;for(var i=0,iLen=fft.length;i<iLen;i++){energy+=this.filter[i]*fft[i]*fft[i];}
this.energy=energy;this.ready.energy=true;return energy;},monitor:function(){var self=this;var energy=this.getEnergy();var signal=energy-this.energy_offset;if(signal>this.energy_threshold_pos){this.voiceTrend=(this.voiceTrend+1>this.voiceTrendMax)?this.voiceTrendMax:this.voiceTrend+1;}else if(signal<-this.energy_threshold_neg){this.voiceTrend=(this.voiceTrend-1<this.voiceTrendMin)?this.voiceTrendMin:this.voiceTrend-1;}else{ if(this.voiceTrend>0){this.voiceTrend--;}else if(this.voiceTrend<0){this.voiceTrend++;}}
var start=false,end=false;if(this.voiceTrend>this.voiceTrendStart){ start=true;}else if(this.voiceTrend<this.voiceTrendEnd){ end=true;}
var integration=signal*this.iterationPeriod*this.options.energy_integration;if(integration>0||!end){this.energy_offset+=integration;}else{this.energy_offset+=integration*10;}
this.energy_offset=this.energy_offset<0?0:this.energy_offset;this.energy_threshold_pos=this.energy_offset*this.options.energy_threshold_ratio_pos;this.energy_threshold_neg=this.energy_offset*this.options.energy_threshold_ratio_neg; if(start&&!this.vadState){this.vadState=true;this.options.speechStart();}
if(end&&this.vadState){this.vadState=false;this.options.speechEnd();}
return signal;}};return Vad;}(window.webspeechkit));(function(webspeechkit){webspeechkit.Dictation=function(asr_url,uuid,apikey){this.send=0;this.send_bytes=0;this.proc=0;this.recorder=null;this.recognizer=null;this.vad=null;this.asr_url=asr_url;this.uuid=uuid;this.apikey=apikey;}
webspeechkit.Dictation.prototype={webSocketPath:function(){if((this.asr_url.indexOf("wss://")==0)||(this.asr_url.indexOf("ws://")==0))
return this.asr_url;var loc=window.location,new_uri;if(loc.protocol==="https:"){new_uri="wss:";}else{new_uri="ws:";}
new_uri+="//"+this.asr_url;return new_uri;},start:function(options){var donothing=function(){};this.options={initCallback:donothing,errorCallback:donothing,dataCallback:donothing,infoCallback:donothing,stopCallback:donothing,punctuation:false,model:"freeform",lang:"ru-RU",format:webspeechkit.FORMAT.PCM16,vad:false,speechStart:donothing,speechEnd:donothing,bufferSize:1024};for(var option in options){if(this.options.hasOwnProperty(option)){this.options[option]=options[option];}}
if(webspeechkit.recorderInited){this.onstart();}
else{webspeechkit.initRecorder(this.onstart.bind(this),this.options.errorCallback)}},onstart:function(){if(this.recorder&&this.recorder.isPaused())
this.recorder.start();if(this.recognizer)
return;this.send=0;this.send_bytes=0;this.proc=0;if(!this.recorder){this.recorder=new webspeechkit.Recorder(this.options.bufferSize,1,function(){this.options.errorCallback("Failed to create Recorder");}.bind(this),null,this.options.format.samplerate);if(this.options.vad)
this.vad=new webspeechkit.Vad({recorder:this.recorder,speechStart:this.options.speechStart,speechEnd:this.options.speechEnd});}
this.recognizer=new webspeechkit.Recognizer(this.webSocketPath(),{onInit:function(sessionId,code){this.recorder.start(function(data){if(this.options.vad&&this.vad){this.vad.update();}
this.send++;this.send_bytes+=data.byteLength;this.options.infoCallback({send_bytes:this.send_bytes,format:this.options.format,send_packages:this.send,processed:this.proc});this.recognizer.addData(data);}.bind(this),this.options.format)
this.options.initCallback(sessionId,code);}.bind(this),onResult:function(text,uttr,merge){this.proc+=merge;this.options.dataCallback(text,uttr,merge);}.bind(this),onError:function(msg){this.recorder.stop(function(){});this.recognizer.close()
this.recognizer=null;this.options.errorCallback(msg);}.bind(this)},{uuid:this.uuid,key:this.apikey,model:this.options.model,lang:this.options.lang,format:this.options.format.mime,punctuation:this.options.punctuation,});this.recognizer.start();},stop:function(){if(this.recognizer)
this.recognizer.close();this.recorder.stop(function(){this.recognizer=null;this.options.stopCallback();}.bind(this));},pause:function(){this.recorder.pause();},isPaused:function(){return(!this.recorder||this.recorder.isPaused());}};}(window.webspeechkit));(function(webspeechkit){webspeechkit.Spotter=function(asr_url,uuid,apikey){this.send=0;this.send_bytes=0;this.proc=0;this.recorder=null;this.recognizer=null;this.vad=null;this.asr_url=asr_url;this.uuid=uuid;this.apikey=apikey;var backref=this;this.webSocketPath=function(){if((this.asr_url.indexOf("wss://")==0)||(this.asr_url.indexOf("ws://")==0))
return this.asr_url;var loc=window.location,new_uri;if(loc.protocol==="https:"){new_uri="wss:";}else{new_uri="ws:";}
new_uri+="//"+this.asr_url;return new_uri;};this.start=function(options){var donothing=function(){};this.options={initCallback:donothing,errorCallback:donothing,dataCallback:donothing,infoCallback:donothing,stopCallback:donothing,punctuation:false,format:webspeechkit.FORMAT.PCM16,vad:false,speechStart:donothing,speechEnd:donothing,bufferSize:1024,phrases:[]};for(var option in options){if(this.options.hasOwnProperty(option)){this.options[option]=options[option];}}
if(webspeechkit.recorderInited){this.onstart();}
else{webspeechkit.initRecorder(this.onstart.bind(this),this.options.errorCallback)}};this.onstart=function(){if(this.recorder&&this.recorder.isPaused())
this.recorder.start();if(this.recognizer)
return;this.send=0;this.send_bytes=0;this.proc=0;if(!this.recorder){this.recorder=new webspeechkit.Recorder(this.options.bufferSize,1,function(){this.options.errorCallback("Failed to create Recorder");}.bind(this),null,this.options.format.samplerate);if(this.options.vad)
this.vad=new webspeechkit.Vad({recorder:this.recorder,speechStart:this.options.speechStart,speechEnd:this.options.speechEnd});}
this.recognizer=new webspeechkit.Recognizer(this.webSocketPath(),{onInit:function(sessionId,code){backref.recorder.start(function(data){if(backref.options.vad&&backref.vad){backref.vad.update();}
backref.send++;backref.send_bytes+=data.byteLength;backref.options.infoCallback({send_bytes:backref.send_bytes,format:backref.options.format,send_packages:backref.send,processed:backref.proc});backref.recognizer.addData(data);},backref.options.format)
backref.options.initCallback(sessionId,code);},onResult:function(text,uttr,merge){backref.proc+=merge;backref.options.dataCallback(text,uttr,merge);},onError:function(msg){backref.recorder.stop(function(){});backref.recognizer.close()
backref.recognizer=null;backref.options.errorCallback(msg);}},{uuid:this.uuid,key:this.apikey,format:this.options.format.mime,phrases:this.options.phrases});this.recognizer.start();};this.stop=function(){if(backref.recognizer)
backref.recognizer.close();backref.recorder.stop(function(){backref.recognizer=null;backref.options.stopCallback();});};this.pause=function(){backref.recorder.pause();};this.isPaused=function(){return(!backref.recorder||backref.recorder.isPaused());};};}(window.webspeechkit));